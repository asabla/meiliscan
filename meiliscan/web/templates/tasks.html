{% extends "base.html" %}

{% block title %}Tasks - Meiliscan{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-2">
    <h1 style="font-size: 1.75rem;">Tasks Queue</h1>
    {% if is_live %}
    <div class="flex items-center gap-1">
        <span id="poll-status" class="badge badge-yellow">Paused</span>
        <button id="toggle-polling" class="btn btn-secondary btn-sm" onclick="togglePolling()">
            Live
        </button>
        <button class="btn btn-secondary btn-sm" onclick="refreshTasks()">
            Refresh
        </button>
    </div>
    {% else %}
    <span class="badge badge-gray">From Dump</span>
    {% endif %}
</div>

{% if error %}
<div class="alert alert-error mb-2">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

<!-- Tasks Summary -->
{% if summary %}
<div class="grid grid-5 mb-2">
    <div class="card">
        <div class="stat">
            <div class="stat-value">{{ summary.total }}</div>
            <div class="stat-label">Total</div>
        </div>
    </div>
    <div class="card">
        <div class="stat">
            <div class="stat-value text-green">{{ summary.succeeded }}</div>
            <div class="stat-label">Succeeded</div>
        </div>
    </div>
    <div class="card">
        <div class="stat">
            <div class="stat-value text-red">{{ summary.failed }}</div>
            <div class="stat-label">Failed</div>
        </div>
    </div>
    <div class="card">
        <div class="stat">
            <div class="stat-value text-blue">{{ summary.processing + summary.enqueued }}</div>
            <div class="stat-label">Active</div>
        </div>
    </div>
    <div class="card">
        <div class="stat">
            <div class="stat-value">{{ "%.1f"|format(summary.success_rate) }}%</div>
            <div class="stat-label">Success Rate</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filters -->
<div class="card mb-2">
    <div class="flex items-center gap-2 flex-wrap">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="status-filter" style="display: inline; margin-right: 0.5rem;">Status</label>
            <select id="status-filter" onchange="applyFilters()" style="width: auto;">
                <option value="">All</option>
                <option value="succeeded" {% if current_status == 'succeeded' %}selected{% endif %}>Succeeded</option>
                <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>Failed</option>
                <option value="processing" {% if current_status == 'processing' %}selected{% endif %}>Processing</option>
                <option value="enqueued" {% if current_status == 'enqueued' %}selected{% endif %}>Enqueued</option>
                <option value="canceled" {% if current_status == 'canceled' %}selected{% endif %}>Canceled</option>
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label for="type-filter" style="display: inline; margin-right: 0.5rem;">Type</label>
            <select id="type-filter" onchange="applyFilters()" style="width: auto;">
                <option value="">All</option>
                <option value="documentAdditionOrUpdate" {% if current_type == 'documentAdditionOrUpdate' %}selected{% endif %}>Document Add/Update</option>
                <option value="documentDeletion" {% if current_type == 'documentDeletion' %}selected{% endif %}>Document Delete</option>
                <option value="settingsUpdate" {% if current_type == 'settingsUpdate' %}selected{% endif %}>Settings Update</option>
                <option value="indexCreation" {% if current_type == 'indexCreation' %}selected{% endif %}>Index Creation</option>
                <option value="indexDeletion" {% if current_type == 'indexDeletion' %}selected{% endif %}>Index Deletion</option>
                <option value="indexSwap" {% if current_type == 'indexSwap' %}selected{% endif %}>Index Swap</option>
                <option value="dumpCreation" {% if current_type == 'dumpCreation' %}selected{% endif %}>Dump Creation</option>
            </select>
        </div>
        
        {% if indexes %}
        <div class="form-group" style="margin-bottom: 0;">
            <label for="index-filter" style="display: inline; margin-right: 0.5rem;">Index</label>
            <select id="index-filter" onchange="applyFilters()" style="width: auto;">
                <option value="">All</option>
                {% for idx in indexes %}
                <option value="{{ idx }}" {% if current_index == idx %}selected{% endif %}>{{ idx }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        
        <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Clear</button>
    </div>
</div>

<!-- Tasks List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Recent Tasks</h2>
        <span id="refresh-indicator" class="text-muted" style="font-size: 0.75rem;"></span>
    </div>
    
    <div id="tasks-list"
         hx-get="/tasks/list?status={{ current_status or '' }}&task_type={{ current_type or '' }}&index={{ current_index or '' }}"
         hx-trigger="load"
         hx-swap="innerHTML">
        <!-- Tasks will be loaded here -->
        <div class="text-center text-muted" style="padding: 2rem;">
            Loading tasks...
        </div>
    </div>
</div>

<script>
let pollingEnabled = false;  // Default to paused
let pollingInterval = null;
let currentSortColumn = 'enqueued';
let currentSortDirection = 'desc';

function togglePolling() {
    pollingEnabled = !pollingEnabled;
    const btn = document.getElementById('toggle-polling');
    const status = document.getElementById('poll-status');
    
    if (pollingEnabled) {
        btn.textContent = 'Pause';
        status.textContent = 'Live';
        status.className = 'badge badge-green';
        // Start polling
        startPolling();
    } else {
        btn.textContent = 'Live';
        status.textContent = 'Paused';
        status.className = 'badge badge-yellow';
        // Stop polling
        stopPolling();
    }
}

function startPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(refreshTasks, 5000);
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

function refreshTasks() {
    const tasksList = document.getElementById('tasks-list');
    htmx.ajax('GET', tasksList.getAttribute('hx-get'), {target: '#tasks-list', swap: 'innerHTML'});
}

function applyFilters() {
    const status = document.getElementById('status-filter').value;
    const taskType = document.getElementById('type-filter').value;
    const index = document.getElementById('index-filter')?.value || '';
    
    const params = new URLSearchParams();
    if (status) params.set('status', status);
    if (taskType) params.set('task_type', taskType);
    if (index) params.set('index', index);
    
    // Update URL without reloading
    const newUrl = '/tasks' + (params.toString() ? '?' + params.toString() : '');
    window.history.pushState({}, '', newUrl);
    
    // Build HTMX endpoint URL
    const htmxUrl = '/tasks/list' + (params.toString() ? '?' + params.toString() : '');
    const tasksList = document.getElementById('tasks-list');
    tasksList.setAttribute('hx-get', htmxUrl);
    
    // Trigger HTMX request
    htmx.ajax('GET', htmxUrl, {target: '#tasks-list', swap: 'innerHTML'});
}

function clearFilters() {
    document.getElementById('status-filter').value = '';
    document.getElementById('type-filter').value = '';
    const indexFilter = document.getElementById('index-filter');
    if (indexFilter) indexFilter.value = '';
    applyFilters();
}

function sortTable(column, type) {
    const table = document.getElementById('tasks-table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const headers = table.querySelectorAll('th.sortable');
    
    // Determine sort direction
    let direction = 'asc';
    if (currentSortColumn === column) {
        direction = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else if (column === 'uid' || column === 'enqueued' || column === 'duration') {
        // Default to descending for numeric/date columns
        direction = 'desc';
    }
    
    currentSortColumn = column;
    currentSortDirection = direction;
    
    // Update header classes
    headers.forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === column) {
            th.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    });
    
    // Sort rows
    rows.sort((a, b) => {
        let aVal = a.dataset[column] || '';
        let bVal = b.dataset[column] || '';
        
        let comparison = 0;
        
        if (type === 'number' || type === 'duration') {
            comparison = parseFloat(aVal || 0) - parseFloat(bVal || 0);
        } else if (type === 'date') {
            comparison = new Date(aVal) - new Date(bVal);
        } else {
            comparison = aVal.localeCompare(bVal);
        }
        
        return direction === 'asc' ? comparison : -comparison;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// Update timestamp on each refresh
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'tasks-list') {
        const indicator = document.getElementById('refresh-indicator');
        if (indicator) {
            indicator.textContent = 'Updated ' + new Date().toLocaleTimeString();
        }
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', stopPolling);
</script>
{% endblock %}
