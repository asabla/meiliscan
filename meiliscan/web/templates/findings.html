{% extends "base.html" %}

{% block title %}Findings - Meiliscan{% endblock %}

{% block content %}
<h1 style="font-size: 1.75rem; margin-bottom: 1.5rem;">Findings Explorer</h1>

{% if report %}

<!-- Severity Summary -->
<div class="card mb-2">
    <div class="card-header">
        <h2 class="card-title">Issues by Severity</h2>
    </div>
    <div class="flex gap-2 flex-wrap">
        <button onclick="filterBySeverity('critical')" 
           class="badge badge-red{% if current_severity == 'critical' %} badge-active{% endif %}" style="cursor: pointer; border: none;">
            {{ severity_counts.critical }} Critical
        </button>
        <button onclick="filterBySeverity('warning')" 
           class="badge badge-yellow{% if current_severity == 'warning' %} badge-active{% endif %}" style="cursor: pointer; border: none;">
            {{ severity_counts.warning }} Warnings
        </button>
        <button onclick="filterBySeverity('suggestion')" 
           class="badge badge-blue{% if current_severity == 'suggestion' %} badge-active{% endif %}" style="cursor: pointer; border: none;">
            {{ severity_counts.suggestion }} Suggestions
        </button>
        <button onclick="filterBySeverity('info')" 
           class="badge badge-gray{% if current_severity == 'info' %} badge-active{% endif %}" style="cursor: pointer; border: none;">
            {{ severity_counts.info }} Info
        </button>
        {% if current_severity %}
        <button onclick="filterBySeverity('')" 
           class="badge badge-outline" style="cursor: pointer; border: none;">
            Clear severity filter
        </button>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<div class="card mb-2">
    <div class="flex items-center gap-2 flex-wrap">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="severity-filter" style="display: inline; margin-right: 0.5rem;">Severity</label>
            <select id="severity-filter" onchange="applyFilters()" style="width: auto;">
                <option value="">All</option>
                <option value="critical" {% if current_severity == 'critical' %}selected{% endif %}>Critical</option>
                <option value="warning" {% if current_severity == 'warning' %}selected{% endif %}>Warning</option>
                <option value="suggestion" {% if current_severity == 'suggestion' %}selected{% endif %}>Suggestion</option>
                <option value="info" {% if current_severity == 'info' %}selected{% endif %}>Info</option>
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label for="category-filter" style="display: inline; margin-right: 0.5rem;">Category</label>
            <select id="category-filter" onchange="applyFilters()" style="width: auto;">
                <option value="">All</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if current_category == cat %}selected{% endif %}>{{ cat|title }}</option>
                {% endfor %}
            </select>
        </div>
        
        {% if indexes %}
        <div class="form-group" style="margin-bottom: 0;">
            <label for="index-filter" style="display: inline; margin-right: 0.5rem;">Index</label>
            <select id="index-filter" onchange="applyFilters()" style="width: auto;">
                <option value="">All</option>
                {% for idx in indexes %}
                <option value="{{ idx }}" {% if current_index == idx %}selected{% endif %}>{{ idx }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        
        <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Clear</button>
    </div>
</div>

<!-- Findings List -->
<div id="findings-list"
     hx-get="/findings/list?severity={{ current_severity or '' }}&category={{ current_category or '' }}&index={{ current_index or '' }}"
     hx-trigger="load"
     hx-swap="innerHTML">
    <!-- Findings will be loaded here -->
    <div class="text-center text-muted" style="padding: 2rem;">
        Loading findings...
    </div>
</div>

<script>
function filterBySeverity(severity) {
    document.getElementById('severity-filter').value = severity;
    applyFilters();
}

function applyFilters() {
    const severity = document.getElementById('severity-filter').value;
    const category = document.getElementById('category-filter').value;
    const index = document.getElementById('index-filter')?.value || '';
    
    const params = new URLSearchParams();
    if (severity) params.set('severity', severity);
    if (category) params.set('category', category);
    if (index) params.set('index', index);
    
    // Update URL without reloading
    const newUrl = '/findings' + (params.toString() ? '?' + params.toString() : '');
    window.history.pushState({}, '', newUrl);
    
    // Build HTMX endpoint URL
    const htmxUrl = '/findings/list' + (params.toString() ? '?' + params.toString() : '');
    const findingsList = document.getElementById('findings-list');
    findingsList.setAttribute('hx-get', htmxUrl);
    
    // Trigger HTMX request
    htmx.ajax('GET', htmxUrl, {target: '#findings-list', swap: 'innerHTML'});
    
    // Update severity badge highlights
    updateSeverityBadges(severity);
}

function clearFilters() {
    document.getElementById('severity-filter').value = '';
    document.getElementById('category-filter').value = '';
    const indexFilter = document.getElementById('index-filter');
    if (indexFilter) indexFilter.value = '';
    applyFilters();
}

function updateSeverityBadges(selectedSeverity) {
    // This updates the badge active states after HTMX loads
    const badges = document.querySelectorAll('.card:first-of-type .badge');
    badges.forEach(badge => {
        badge.classList.remove('badge-active');
    });
    
    if (selectedSeverity) {
        // Find and highlight the selected severity badge
        const severityMap = {
            'critical': 0,
            'warning': 1,
            'suggestion': 2,
            'info': 3
        };
        const idx = severityMap[selectedSeverity];
        if (idx !== undefined && badges[idx]) {
            badges[idx].classList.add('badge-active');
        }
    }
}
</script>

{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">üîç</div>
        <h2>No Analysis Data</h2>
        <p class="text-secondary">Connect to a MeiliSearch instance or upload a dump file first.</p>
        <a href="/" class="btn btn-primary mt-2">Go to Dashboard</a>
    </div>
</div>
{% endif %}
{% endblock %}
